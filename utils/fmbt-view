#!/bin/bash

# fMBT, free Model Based Testing tool
# Copyright (c) 2011,2012 Intel Corporation.
#
# This program is free software; you can redistribute it and/or modify it
# under the terms and conditions of the GNU Lesser General Public License,
# version 2.1, as published by the Free Software Foundation.
#
# This program is distributed in the hope it will be useful, but WITHOUT
# ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
# FITNESS FOR A PARTICULAR PURPOSE.  See the GNU Lesser General Public License for
# more details.
#
# You should have received a copy of the GNU Lesser General Public License along with
# this program; if not, write to the Free Software Foundation, Inc.,
# 51 Franklin St - Fifth Floor, Boston, MA 02110-1301 USA.

if [ "x$1" == "x" ] || [ "$1" == "-h" ] || [ "$1" == "--help" ]; then
    echo "Usage: fmbt-view [options] modelname.lsts"
    echo "Options:"
    echo "  -f <format>"
    echo "          Default format is pdf. Other supported formats are:"
    echo -n "         "; dot -Thelp 2>&1 | sed 's/.*://'
    echo "  -h      Print help."
    echo "  -l <logfile>"
    echo "          Color states and transitions visited in the log."
    echo "  -i      Invert coloring (highlights unvisited states)"
    echo "  -o <outputfile>"
    echo "          Write image to outputfile, do not display it."
    exit 1
fi

FORMAT=pdf
LOGFILE=""
OUTPUTFILE=""
COLORING=""
DISPLAY_IMAGE=1
while getopts f:il:o:v opt
do
    case $opt in
	v) echo "Version" exit 0;;
        f) FORMAT=$OPTARG;;
        i) COLORING="--invert-colors";;
        l) LOGFILE="-l $OPTARG";;
        o) OUTPUTFILE=$OPTARG; DISPLAY_IMAGE=0;;
    esac
done
shift $(expr $OPTIND - 1)

UTILPATH="$(dirname "$0")"
if [ "$OUTPUTFILE" == "" ]; then
        OUTPUTFILE=$(mktemp --suffix ."$FORMAT") || { echo "Can't create temporary file:""$OUTPUTFILE"; exit 1;}
fi

( eval $UTILPATH/lsts2dot --loops-in-states -i "$1" $COLORING $LOGFILE | dot -T$FORMAT -o"$OUTPUTFILE" ) && {

    if [ "$DISPLAY_IMAGE" == "1" ]; then
        echo "Graphviz output saved to $OUTPUTFILE"
        echo "Displaying..."
        display "$OUTPUTFILE"
    fi
}

rm "$OUTPUTFILE"